<div class="transfer-container">
  <!-- Top banner header -->
  <nav class="navbar navbar-expand-lg transfer-navbar" [class.dark]="isDarkMode()">
    <div class="container-fluid">
      <span class="navbar-brand">Queue Board â€” Transfer</span>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <!-- Dark mode toggle -->
        <button
          class="btn btn-outline-light"
          (click)="toggleDarkMode()"
          [title]="isDarkMode() ? 'Switch to light mode' : 'Switch to dark mode'"
        >
          @if (isDarkMode()) {
            <span aria-hidden="true">ðŸŒž</span>
          } @else {
            <span aria-hidden="true">ðŸŒ™</span>
          }
        </button>
        <!-- Connect / status -->
        <button
          class="btn btn-outline-light"
          (click)="connectGoogle()"
          [disabled]="connecting() || trans_google()"
        >
          @if (connecting()) {
            <span>Connectingâ€¦</span>
          } @else if (trans_google()) {
            <span>Connected</span>
          } @else {
            <span>Connect Google</span>
          }
        </button>
        <!-- Manual load from local/IndexedDB -->
        <button
          class="btn btn-outline-secondary"
          type="button"
          (click)="loadSavedPlaylists()"
          [disabled]="connecting()"
          title="Load playlists saved locally"
        >
          Load saved
        </button>
      </div>
    </div>
  </nav>

  <div class="transfer-body">
    <div class="intro container-fluid py-3">
      <h2 class="h4 mb-2">Transfer Playlists</h2>
      <p class="text-muted mb-3">
        Move or examine playlists between services. Connect Google to begin.
      </p>
      <div class="d-flex gap-2 flex-wrap">
        <button
          class="btn btn-primary"
          (click)="connectGoogle()"
          [disabled]="connecting() || trans_google()"
        >
          @if (connecting()) {
            <span>Connectingâ€¦</span>
          } @else if (trans_google()) {
            <span>Re-connect Google</span>
          } @else {
            <span>Connect Google</span>
          }
        </button>
        <button class="btn btn-success" disabled title="Spotify integration coming soon">
          Connect Spotify (soon)
        </button>
      </div>
    </div>

    @if (trans_google()) {
      <div class="playlist-info container-fluid mb-2 text-muted small">
        {{ googlePlaylists().length }} playlists loaded.
      </div>

      <div class="search-container container-fluid">
        <h3 class="h6">Filter Playlists</h3>
        <div class="input-group mb-3">
          <input
            type="text"
            class="form-control"
            placeholder="Filter playlists"
            [ngModel]="playlistSearchQuery()"
            (ngModelChange)="playlistSearchQuery.set($event)"
          />
        </div>

        <!-- Dark-mode aware list group -->
        <ul class="list-group" [class.list-group-dark]="isDarkMode()">
          <li
            class="list-group-item d-flex flex-column"
            *ngFor="
              let playlist of filteredGooglePlaylists();
              let pIndex = index;
              trackBy: trackById
            "
            [class.list-group-item-dark]="isDarkMode()"
          >
            <div class="d-flex justify-content-between align-items-center w-100">
              <div class="d-flex gap-2 align-items-baseline">
                <span class="playlist-number text-muted small">{{ pIndex + 1 }}.</span>
                <div class="playlist-title">{{ playlist.title }}</div>
              </div>
              <button
                class="btn btn-sm btn-outline-primary"
                type="button"
                (click)="loadVideosForPlaylist(playlist.id)"
                [disabled]="loadingVideos()[playlist.id]"
              >
                <ng-container *ngIf="!loadingVideos()[playlist.id]">
                  {{ expandedPlaylists()[playlist.id] ? 'Hide' : 'Load videos' }}
                </ng-container>
                <ng-container *ngIf="loadingVideos()[playlist.id]">Loadingâ€¦</ng-container>
              </button>
            </div>

            <!-- Only render the numeric list when the playlist is expanded -->
            <ng-container *ngIf="expandedPlaylists()[playlist.id]">
              <ol class="mt-2 playlist-video-list">
                <li
                  class="small"
                  *ngFor="let v of playlist.videos; let i = index; trackBy: trackById"
                >
                  <span class="video-index">{{ i + 1 }}.</span>
                  <span class="video-title">{{ v.title }}</span>
                </li>
              </ol>
            </ng-container>
          </li>
        </ul>
      </div>

      <div class="search-container container-fluid mt-4">
        <h3 class="h6">Search for Music Videos</h3>
        <div class="input-group mb-3">
          <input
            type="text"
            class="form-control"
            placeholder="Search for a song"
            [ngModel]="searchQuery()"
            (ngModelChange)="searchQuery.set($event)"
          />
          <button class="btn btn-outline-secondary" type="button" (click)="search()">Search</button>
        </div>

        @if (searchResults().length > 0) {
          <ul class="list-group">
            <template>
              @for (video of searchResults(); track video.id.videoId) {
                <li class="list-group-item">
                  {{ video.snippet.title }} - {{ video.snippet.description }}
                </li>
              }
            </template>
          </ul>
        }
      </div>
    }

    <div class="transfer-button-container">
      <button class="btn btn-primary" [disabled]="!trans_google() || !trans_spotify()">
        Transfer
      </button>
    </div>
  </div>
</div>
