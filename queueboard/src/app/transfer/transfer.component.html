<div class="transfer-container">
  <!-- Top banner header -->
  <nav class="navbar navbar-expand-lg transfer-navbar" [class.dark]="isDarkMode()">
    <div class="container-fluid">
      <span class="navbar-brand">Queueboard Transfer </span>
      <div class="ms-auto d-flex gap-2 align-items-center">
      <a routerLink="/organizer" class="btn btn-outline-light">
        Organizer
      </a>

        <!-- Dark mode toggle -->
        <button
          class="btn btn-outline-light"
          (click)="toggleDarkMode()"
          [title]="isDarkMode() ? 'Switch to light mode' : 'Switch to dark mode'"
        >
          @if (isDarkMode()) {
            <span aria-hidden="true">üåû</span>
          } @else {
            <span aria-hidden="true">üåô</span>
          }
        </button>
        <!-- Connect / status -->
        <button
          class="btn btn-outline-light"
          (click)="connectGoogle()"
          [disabled]="connecting() || authenticated()"
        >
          @if (connecting()) {
            <span>Connecting‚Ä¶</span>
          } @else if (authenticated()) {
            <span>Connected</span>
          } @else {
            <span>Connect Google</span>
          }
        </button>
        <!-- Manual load from local/IndexedDB -->
        <button
          class="btn btn-outline-secondary"
          type="button"
          (click)="loadSavedPlaylists()"
          [disabled]="connecting()"
          title="Load playlists saved locally"
        >
          Load saved
        </button>
       
      </div>
    </div>
  </nav>

  <div class="transfer-body">
    <div class="intro container-fluid py-3">
      <h2 class="h4 mb-2">Transfer Playlists</h2>
      <p class="text-muted mb-3">
        Move or examine playlists between services. Connect Google to begin.
      </p>
      <div class="d-flex gap-2 flex-wrap">
        <button
          class="btn btn-primary"
          (click)="connectGoogle()"
          [disabled]="connecting()"
        >
          @if (connecting()) {
            <span>Connecting‚Ä¶</span>
          } @else if (authenticated()) {
            <span>Re-connect Google</span>
          } @else {
            <span>Connect Google</span>
          }
        </button>
        <button class="btn btn-success" (click)="connectSpotify()" [disabled]="connecting()">
          @if (connecting()) {
            <span>Connecting‚Ä¶</span>
          } @else if (trans_spotify()) {
            <span>Re-connect Spotify</span>
          } @else {
            <span>Connect Spotify</span>
          }
        </button>
        @if (trans_spotify()) {
          <button
            class="btn btn-outline-success"
            (click)="loadAllSpotifyData()"
            [disabled]="connecting()"
            title="Load all playlists with complete track data"
          >
            @if (connecting()) {
              <span>Loading All Data‚Ä¶</span>
            } @else {
              <span>Load All Tracks</span>
            }
          </button>
        }
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-6">
          @if (trans_google()) {
            <div class="playlist-info mb-2 text-muted small">
              {{ googlePlaylists().length }} playlists loaded.
            </div>

            <div class="search-container">
              <h3 class="h6">Filter Playlists</h3>
              <div class="input-group mb-3">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Filter playlists"
                  [ngModel]="playlistSearchQuery()"
                  (ngModelChange)="playlistSearchQuery.set($event)"
                />
              </div>

              <!-- Dark-mode aware list group -->
              <ul class="list-group" [class.list-group-dark]="isDarkMode()">
                <li
                  class="list-group-item d-flex flex-column"
                  *ngFor="
                    let playlist of filteredGooglePlaylists();
                    let pIndex = index;
                    trackBy: trackById
                  "
                  [class.list-group-item-dark]="isDarkMode()"
                >
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="d-flex gap-2 align-items-center">
                      <span class="playlist-number text-muted small">{{ pIndex + 1 }}.</span>
                      <div class="playlist-title">{{ playlist.title }}</div>
                      <a [href]="getYouTubePlaylistUrl(playlist.id)" target="_blank" title="Open on YouTube" class="small ms-1">‚ÜóÔ∏è</a>
                    </div>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      type="button"
                      (click)="loadVideosForPlaylist(playlist.id)"
                      [disabled]="loadingVideos()[playlist.id]"
                    >
                      <ng-container *ngIf="!loadingVideos()[playlist.id]">
                        {{ expandedPlaylists()[playlist.id] ? 'Hide' : 'Load videos' }}
                      </ng-container>
                      <ng-container *ngIf="loadingVideos()[playlist.id]">Loading‚Ä¶</ng-container>
                    </button>
                  </div>

                  <!-- Only render the numeric list when the playlist is expanded -->
                  <ng-container *ngIf="expandedPlaylists()[playlist.id]">
                    <ol class="mt-2 playlist-video-list">
                      <li
                        class="small"
                        *ngFor="let v of playlist.videos; let i = index; trackBy: trackById"
                        [style.color]="getSongColor(v, playlist)"
                      >
                        <span class="video-index">{{ i + 1 }}.</span>
                        <span class="video-title">{{ v.title }}</span>
                      </li>
                    </ol>
                  </ng-container>
                </li>
              </ul>
            </div>
          }
        </div>
        <div class="col-lg-6">
          @if (trans_spotify()) {
            <div class="playlist-info mb-2 text-muted small">
              {{ spotifyPlaylists().length }} Spotify playlists loaded.
            </div>

            <div class="search-container">
              <h3 class="h6">Spotify Playlists</h3>
              <div class="input-group mb-3">
                <input
                  type="text"
                  class="form-control"
                  placeholder="Filter Spotify playlists"
                  [ngModel]="playlistSearchQuery()"
                  (ngModelChange)="playlistSearchQuery.set($event)"
                />
              </div>

              <!-- Dark-mode aware list group for Spotify -->
              <ul class="list-group" [class.list-group-dark]="isDarkMode()">
                <li
                  class="list-group-item d-flex flex-column"
                  *ngFor="
                    let playlist of filteredSpotifyPlaylists();
                    let pIndex = index;
                    trackBy: trackById
                  "
                  [class.list-group-item-dark]="isDarkMode()"
                >
                  <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="d-flex gap-2 align-items-baseline">
                      <span class="playlist-number text-muted small">{{ pIndex + 1 }}.</span>
                      <div class="playlist-title">{{ playlist.title }}</div>
                      <span class="badge bg-success small">Spotify</span>
                    </div>
                    <div class="btn-group">
                        <button
                          class="btn btn-sm btn-outline-success"
                          type="button"
                          (click)="loadVideosForPlaylist(playlist.id)"
                          [disabled]="loadingVideos()[playlist.id]"
                        >
                          <ng-container *ngIf="!loadingVideos()[playlist.id]">
                            {{ expandedPlaylists()[playlist.id] ? 'Hide' : 'Load songs' }}
                          </ng-container>
                          <ng-container *ngIf="loadingVideos()[playlist.id]">Loading‚Ä¶</ng-container>
                        </button>
                        <button
                          class="btn btn-sm btn-outline-primary"
                          type="button"
                          (click)="transferSinglePlaylistSongs(playlist)"
                          [disabled]="connecting() || !authenticated()"
                          title="Transfer songs to YouTube"
                        >
                          Transfer
                        </button>
                    </div>
                  </div>

                  <!-- Only render the numeric list when the playlist is expanded -->
                  <ng-container *ngIf="expandedPlaylists()[playlist.id]">
                    <ol class="mt-2 playlist-video-list">
                      <li
                        class="small"
                        *ngFor="let v of playlist.videos; let i = index; trackBy: trackById"
                      >
                        <span class="video-index">{{ i + 1 }}.</span>
                        <span class="video-title">{{ v.title }}</span>
                      </li>
                    </ol>
                  </ng-container>
                </li>
              </ul>
            </div>
          }
        </div>
      </div>
    </div>
 
    <div class="transfer-button-container">
      <button class="btn btn-primary" [disabled]="!trans_google() || !trans_spotify()" (click)="performTransfer()">
        Transfer Playlists
      </button>
      <button class="btn btn-secondary" [disabled]="!trans_google() || !trans_spotify()" (click)="transferSongsToYouTubePlaylists()">
        Transfer Songs
      </button>
    </div>
  </div>
</div>
