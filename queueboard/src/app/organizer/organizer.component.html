<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">QueueBoard ‚Äî Organizer</span>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <button *ngIf="!hasPlaylists() || !youtube.isAuthenticated()" class="btn btn-outline-light" (click)="connectYouTube()" [disabled]="connecting()">
        <span *ngIf="!connecting()" class="me-1">‚òÅÔ∏è</span>
        <span *ngIf="connecting()" class="me-1">‚è≥</span>
        Connect YouTube
      </button>   
       
      <button class="btn btn-secondary" *ngIf="hasPlaylists() &&  youtube.isAuthenticated()" (click)="refresh()" [disabled]="connecting()">Refresh</button>
      <button class="btn btn-light text-danger" *ngIf="youtube.isAuthenticated() && !connecting()"
        (click)="youtube.signOut(); playlists.set([]);">Sign Out</button>
    </div>
  </div>
</nav>

<div class="organizer-root">
  <div *ngIf="error()" class="error">Error: {{ error() }}</div>
  <div class="controls">
    <input placeholder="Search videos, tags or playlists" [(ngModel)]="search" (focus)="onSearchFocus()"
      (click)="onSearchFocus()" />
  </div>

  <div class="board" cdkDropListOrientation="horizontal" cdkDropListGroup (cdkDropListDropped)="dropPlaylist($event)"
    cdkDropList [cdkDropListData]="filteredPlaylists()">
    <div class="column" *ngFor="let playlist of filteredPlaylists(); trackBy: trackById"
      [style.borderTopColor]="playlist.color" [class.load-more-column]="playlist.id === 'load-more-sentinel'">
      <!-- Regular Playlist Column -->
      <ng-container *ngIf="playlist.id !== 'load-more-sentinel'">
        <div class="card playlist-card" cdkDrag>
          <div class="card-header">
            <div class="fw-bold">{{ playlist.title }}
            <span class="text-muted small">{{ playlist.videos.length }} videos</span></div>
          </div>
          <div class="card-body">
            <div class="video-list" cdkDropList [id]="playlist.id" [cdkDropListData]="playlist.videos"
              (cdkDropListDropped)="drop($event)">
              <div class="video-card" *ngFor="let v of playlist.videos; trackBy: trackById" cdkDrag>
                <div class="video-main">
                  <img *ngIf="v.thumbnail" [src]="v.thumbnail" alt="thumb" (click)="openVideo(v)" role="button"
                    tabindex="0" (keydown.enter)="openVideo(v)" [attr.aria-label]="'Play ' + (v.title || 'video')" [title]="'Play ' + (v.title || 'video')" />
                  <div class="meta" (click)="toggleDetails(v)" role="button" tabindex="0" (keydown.enter)="toggleDetails(v)"
                    [attr.aria-expanded]="v.detailsVisible" [attr.aria-controls]="'Toggle details-' + v.id" [title]="'Details ' + (v.title || 'video')">
                    <div class="title" [title]="'Details ' + (v.title || 'video')">{{ v.title }}</div>
                    <div class="duration">{{ v.duration }}</div>
                  </div>
                  <a class="open" [href]="v.youtubeUrl" target="_blank" rel="noopener" aria-label="Open in new">
                    üîó
                  </a>
                </div>

                <div class="video-details" [class.expanded]="v.detailsVisible">
                  <div class="desc">{{ v.description }}</div>
                  <div class="actions">
                    <button class="btn btn-primary play-btn" (click)="openVideo(v)">
                      ‚ñ∂Ô∏è Play
                    </button>
                  </div>
                </div>
              </div>
              <!-- Load more videos button -->
              <div *ngIf="playlist.nextPageToken" class="load-more-videos-container">
                <button class="btn btn-sm btn-outline-primary" (click)="loadMoreVideos(playlist)">Load More</button>
              </div>
            </div>
          </div>
        </div>

      </ng-container>

      <!-- "Load More" Column -->
      <ng-container *ngIf="playlist.id === 'load-more-sentinel'">
        <div class="card load-more-card">
          <button class="btn btn-primary w-100 h-100" (click)="fetchMorePlaylists()" [disabled]="loadingMore()">
            <span *ngIf="!loadingMore()">Next Page &rarr;</span>
            <div *ngIf="loadingMore()" class="loading-spinner"></div>
          </button>
        </div>
      </ng-container>
    </div>
  </div>

  <div *ngIf="filteredPlaylists().length === 0" class="no-results">No playlists or videos match your search.</div>

  <!-- Overlay player with Angular YouTube Player -->
  <div class="player-overlay" *ngIf="selectedVideo()" [class.minimized]="isMinimized()">
    <div class="player-backdrop" (click)="closeVideo()"></div>
    <div class="player-card">
      <div class="player-header">
        <div class="player-title">{{ selectedVideo()?.title }}</div>
        <div class="d-flex gap-1">
          <button class="btn btn-sm btn-outline-secondary" (click)="minimizeVideo()">‚Äî</button>
          <button class="btn btn-sm btn-outline-secondary" (click)="closeVideo()">‚úï</button>
        </div>
      </div>
      <div class="player-body">
        <youtube-player
          [videoId]="selectedVideo()!.id" [id]="'player-' + selectedVideo()!.id"
          [playerVars]="{autoplay: 1, rel: 0}"
          (ready)="onPlayerReady($event)"
          (stateChange)="onPlayerStateChange($event)">
        </youtube-player>
      </div>
      <div class="player-controls">
        <button class="btn btn-sm btn-outline-secondary" [class.active]="currentPlaybackRate() === 0.75" (click)="setPlaybackRate(0.75)">0.75x</button>
        <button class="btn btn-sm btn-outline-secondary" [class.active]="currentPlaybackRate() === 1" (click)="setPlaybackRate(1)">1x</button>
        <button class="btn btn-sm btn-outline-secondary" [class.active]="currentPlaybackRate() === 1.25" (click)="setPlaybackRate(1.25)">1.25x</button>
        <button class="btn btn-sm btn-outline-secondary" [class.active]="currentPlaybackRate() === 1.5" (click)="setPlaybackRate(1.5)">1.5x</button>
        <button class="btn btn-sm btn-outline-secondary" [class.active]="currentPlaybackRate() === 2" (click)="setPlaybackRate(2)">2x</button>
      </div>
    </div>
  </div>

  <!-- Minimized Videos Stack -->
  <div class="minimized-videos-stack">
    <div *ngFor="let v of minimizedVideos()" class="minimized-video-card" (click)="restoreVideo(v)" role="button" [title]="'Restore ' + v.title">
      <youtube-player
        [videoId]="v.id" [id]="'player-' + v.id"
        [width]="120" [height]="67"
        [playerVars]="{autoplay: 1, rel: 0, controls: 0, showinfo: 0, modestbranding: 1}"         
        (ready)="onPlayerReady($event)"
        (stateChange)="onPlayerStateChange($event)">
      </youtube-player>

      <div class="minimized-video-overlay">
        <!-- This button is now an overlay on top of the mini-player -->
        <button class="btn btn-sm btn-icon" (click)="togglePlayPause(v); $event.stopPropagation();" [title]="playerState() === 1 ? 'Pause' : 'Play'">
          <span *ngIf="playerState() === 1">‚ùö‚ùö</span>
          <span *ngIf="playerState() !== 1">‚ñ∂</span>
        </button>
        <button class="btn btn-sm btn-icon close-minimized" (click)="closeVideo(v); $event.stopPropagation();" title="Close">
          ‚úï
        </button>
      </div>
    </div>
  </div>
</div>