<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">QueueBoard ‚Äî Organizer</span>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <button *ngIf="playlists().length === 0 || playlists()[0]?.id === 'loading'" class="btn btn-outline-light" (click)="connectYouTube()" [disabled]="connecting()">
        <span *ngIf="!connecting()" class="me-1">‚òÅÔ∏è</span>
        <span *ngIf="connecting()" class="me-1">‚è≥</span>
        Connect YouTube
      </button>   
       
      <button class="btn btn-secondary" *ngIf="hasPlaylists()" (click)="refresh()" [disabled]="connecting()">Refresh</button>
      <button class="btn btn-light text-danger" *ngIf="!connecting()"
        (click)="youtube.signOut(); playlists.set([]);">Sign Out</button>
    </div>
  </div>
</nav>

<div class="organizer-root">
  <div *ngIf="error()" class="error">Error: {{ error() }}</div>
  <div class="controls">
    <input placeholder="Search videos, tags or playlists" [(ngModel)]="search" (focus)="onSearchFocus()"
      (click)="onSearchFocus()" />
  </div>

  <div class="board" cdkDropListOrientation="horizontal" cdkDropListGroup (cdkDropListDropped)="dropPlaylist($event)"
    cdkDropList [cdkDropListData]="filteredPlaylists()">
    <div class="column" *ngFor="let playlist of filteredPlaylists(); trackBy: trackById"
      [style.borderTopColor]="playlist.color" [class.load-more-column]="playlist.id === 'load-more-sentinel'">
      <!-- Regular Playlist Column -->
      <ng-container *ngIf="playlist.id !== 'load-more-sentinel'">
        <div class="card playlist-card" cdkDrag>
          <div class="card-header">
            <div class="fw-bold">{{ playlist.title }}</div>
            <div class="text-muted small">{{ playlist.videos.length }} videos</div>
          </div>
          <div class="card-body">
            <div class="video-list" cdkDropList [cdkDropListData]="playlist.videos"
              (cdkDropListDropped)="drop($event, playlist.id)">
              <div class="video-card" *ngFor="let v of playlist.videos; trackBy: trackById" cdkDrag>
                <div class="video-main">
                  <img *ngIf="v.thumbnail" [src]="v.thumbnail" alt="thumb" (click)="openVideo(v)" role="button"
                    tabindex="0" (keydown.enter)="openVideo(v)" [attr.aria-label]="'Play ' + (v.title || 'video')" />
                  <div class="meta">
                    <div class="title" [title]="v.title">{{ v.title }}</div>
                    <div class="duration">{{ v.duration }}</div>
                  </div>
                  <a class="open" [href]="v.youtubeUrl" target="_blank" rel="noopener" aria-label="Open in new">
                    üîó
                  </a>
                </div>

                <div class="video-details">
                  <div class="desc">{{ v.description }}</div>
                  <div class="actions">
                    <button class="btn btn-primary play-btn" (click)="openVideo(v)">
                      ‚ñ∂Ô∏è Play
                    </button>
                    <a class="open-ext" [href]="v.youtubeUrl" target="_blank" rel="noopener">Open on YouTube</a>
                  </div>
                </div>
              </div>
              <!-- Load more videos button -->
              <div *ngIf="playlist.nextPageToken" class="load-more-videos-container">
                <button class="btn btn-sm btn-outline-primary" (click)="loadMoreVideos(playlist)">Load More</button>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn btn-link">Add video</button>
          </div>
        </div>

      </ng-container>

      <!-- "Load More" Column -->
      <ng-container *ngIf="playlist.id === 'load-more-sentinel'">
        <div class="card load-more-card">
          <button class="btn btn-primary w-100 h-100" (click)="fetchMorePlaylists()" [disabled]="loadingMore()">
            <span *ngIf="!loadingMore()">Next Page &rarr;</span>
            <div *ngIf="loadingMore()" class="loading-spinner"></div>
          </button>
        </div>
      </ng-container>
    </div>
  </div>

  <div *ngIf="filteredPlaylists().length === 0" class="no-results">No playlists or videos match your search.</div>

  <!-- Overlay player -->
  <div class="player-overlay" *ngIf="selectedVideo()">
    <div class="player-backdrop" (click)="closeVideo()"></div>
    <div class="player-card">
      <div class="player-header">
        <div class="player-title">{{ selectedVideo()?.title }}</div>
        <button class="btn btn-sm btn-outline-secondary" (click)="closeVideo()">‚úï</button>
      </div>
      <div class="player-body">
        <iframe *ngIf="embedUrl()" [src]="embedUrl()" frameborder="0" allow="autoplay; encrypted-media"
          allowfullscreen></iframe>
      </div>
    </div>
  </div>
</div>