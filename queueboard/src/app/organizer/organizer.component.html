<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <span class="navbar-brand">Queue Board ‚Äî Organizer</span>
    <div class="ms-auto d-flex gap-2 align-items-center">
      <!-- Dark mode toggle always visible -->
      <button
        class="btn btn-outline-light"
        (click)="toggleDarkMode()"
        [title]="isDarkMode() ? 'Switch to light mode' : 'Switch to dark mode'"
      >
        @if (isDarkMode()) { <span>üåû</span> } @else { <span>üåô</span> }
      </button>
      @if (!authenticated()) {
      <button class="btn btn-outline-light" (click)="connectYouTube()" [disabled]="connecting()">
        @if (!connecting()) { <span class="me-1">‚òÅÔ∏è</span> } @if (connecting()) {
        <span class="me-1">‚è≥</span> } Connect YouTube
      </button>
      } @else {
      <button
        class="btn btn-secondary"
        (click)="refresh()"
        [disabled]="connecting() || !hasPlaylists()"
      >
        Refresh
      </button>
      <button class="btn btn-light text-danger" (click)="signOut()" [disabled]="connecting()">
        Sign Out
      </button>
      }
    </div>
  </div>
</nav>

<div class="organizer-root">
  @if(!hasPlaylists()){
  <!-- Welcome screen shown when no playlists are loaded -->
  <app-welcome-screen [connecting]="connecting" (connectYouTube)="connectYouTube()">
  </app-welcome-screen>
  }@else if (error()) {
  <div class="error" [textContent]="'Error: ' + error()"></div>
  } @else{
  <div class="controls d-flex gap-2">
    <input
      #searchInput
      class="form-control flex-grow-1"
      placeholder="Search videos, tags or playlists"
      [(ngModel)]="search"
      [disabled]="!hasPlaylists()"
      (focus)="onSearchFocus()"
      (click)="onSearchFocus()"
    />

    <div class="sort-and-add" [class.expanded]="showAddPlaylist()">
      @if (!showAddPlaylist()) {
      <select
        class="form-select sort-dropdown"
        [ngModel]="currentSortOrder()"
        (ngModelChange)="onSortOrderChange($event)"
        [disabled]="!hasPlaylists()"
        title="Sort playlists"
      >
        @for (option of sortOptions; track option.value) {
        <option [value]="option.value">
          {{ option.label }}
        </option>
        }
      </select>
      }
      <!-- Add playlist controls (full width when expanded) -->
      <div class="add-playlist d-flex align-items-center">
        @if (!showAddPlaylist()) {
        <button
          class="btn btn-outline-primary add-playlist-trigger"
          (click)="showAddPlaylist.set(true)"
          aria-label="Add Playlist"
          title="Add Playlist"
        >
          <span class="plus-icon" aria-hidden="true">+</span>
          <span class="btn-label">Playlist</span>
        </button>
        } @else {
        <div class="d-flex gap-2 align-items-center add-playlist-form">
          <input
            class="form-control form-control-sm flex-grow-1"
            placeholder="Playlist name"
            [(ngModel)]="newPlaylistName"
          />
          <button
            class="btn btn-sm btn-primary"
            (click)="createPlaylistFromUI()"
            [disabled]="connecting()"
          >
            Create
          </button>
          <button
            class="btn btn-sm btn-secondary"
            (click)="showAddPlaylist.set(false); newPlaylistName.set('')"
          >
            Cancel
          </button>
        </div>
        }
      </div>
    </div>
  </div>

  <div
    class="board"
    cdkDropListOrientation="horizontal"
    cdkDropListGroup
    (cdkDropListDropped)="dropPlaylist($event)"
    cdkDropList
    [cdkDropListData]="filteredPlaylists()"
  >
    @for (playlist of filteredPlaylists(); track playlist.id) {
    <div
      class="column"
      [style.borderTopColor]="playlist.color"
      [class.load-more-column]="playlist.id === 'load-more-sentinel'"
    >
      <!-- Regular Playlist Column -->
      @if (playlist.id !== 'load-more-sentinel') {
      <div class="card playlist-card" cdkDrag>
        <div class="card-header">
          <div class="fw-bold">
            {{ playlist.title }}
            <span class="text-muted small">{{ playlist.videos.length }} videos</span>
          </div>
        </div>
        <div class="card-body">
          <div
            class="video-list"
            cdkDropList
            [id]="playlist.id"
            [cdkDropListData]="playlist.videos"
            (cdkDropListDropped)="drop($event)"
          >
            @for (v of playlist.videos; track v.id) {
            <div class="video-card" cdkDrag>
              <div class="video-main">
                <img
                  *ngIf="v.thumbnail"
                  [src]="v.thumbnail"
                  alt="thumb"
                  (click)="openVideo(v)"
                  role="button"
                  tabindex="0"
                  (keydown.enter)="openVideo(v)"
                  [attr.aria-label]="'Play ' + (v.title || 'video')"
                  [title]="'Play ' + (v.title || 'video')"
                />
                <div
                  class="meta"
                  (click)="toggleDetails(v)"
                  role="button"
                  tabindex="0"
                  (keydown.enter)="toggleDetails(v)"
                  [attr.aria-expanded]="v.detailsVisible"
                  [attr.aria-controls]="'Toggle details-' + v.id"
                  [title]="'Details ' + (v.title || 'video')"
                >
                  <div class="title" [title]="'Details ' + (v.title || 'video')">
                    {{ v.title }}
                  </div>
                  <div class="duration">{{ v.duration }}</div>
                </div>
                <a
                  class="open"
                  [href]="v.youtubeUrl"
                  target="_blank"
                  rel="noopener"
                  aria-label="Open in new"
                >
                  üîó
                </a>
              </div>

              <div class="video-details" [class.expanded]="v.detailsVisible">
                <div class="desc">{{ v.description }}</div>
                <div class="actions">
                  <button class="btn btn-primary play-btn" (click)="openVideo(v)">‚ñ∂Ô∏è Play</button>
                </div>
              </div>
            </div>
            <!-- Load more videos button - DISABLED (pagination removed) -->
            <!-- TODO: Re-enable when pagination is restored -->
            <!--
              <div *ngIf="playlist.nextPageToken" class="load-more-videos-container">
                <button class="btn btn-sm btn-outline-primary" (click)="loadMoreVideos(playlist)">Load More</button>
              </div>
              -->
            }
          </div>
        </div>
        <div class="card-footer playlist-footer">
          @if (!addVideoVisible()[playlist.id]) {
          <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">{{ playlist.videos.length }} videos</div>
            <button class="btn btn-sm btn-outline-primary" (click)="showAddVideoForm(playlist.id)">
              + Add video
            </button>
          </div>
          } @if (addVideoVisible()[playlist.id]) {
          <div class="d-flex gap-2 align-items-center">
            <input
              #videoUrlInput
              class="form-control form-control-sm"
              placeholder="YouTube URL or ID"
              [disabled]="addVideoLoading()[playlist.id]"
            />
            <button
              class="btn btn-sm btn-primary"
              (click)="addVideoToPlaylistUI(playlist.id, videoUrlInput.value)"
              [disabled]="addVideoLoading()[playlist.id]"
            >
              @if (!addVideoLoading()[playlist.id]) { <span>Add</span> } @if
              (addVideoLoading()[playlist.id]) { <span>Adding‚Ä¶</span> }
            </button>
            <button
              class="btn btn-sm btn-secondary"
              (click)="hideAddVideoForm(playlist.id)"
              [disabled]="addVideoLoading()[playlist.id]"
            >
              Cancel
            </button>
          </div>
          }
        </div>
      </div>
      }

      <!-- "Load More" Column - DISABLED (pagination removed) -->
      <!-- TODO: Re-enable when pagination is restored -->
      <!--
      <ng-container *ngIf="playlist.id === 'load-more-sentinel'">
        <div class="card load-more-card">
          <button class="btn btn-primary w-100 h-100" (click)="fetchMorePlaylists()" [disabled]="loadingMore()">
            <span *ngIf="!loadingMore()">Next Page &rarr;</span>
            <div *ngIf="loadingMore()" class="loading-spinner"></div>
          </button>
        </div>
      </ng-container>
      -->
    </div>
    }
  </div>

  @if (filteredPlaylists().length === 0) {
  <div class="no-results">No playlists or videos match your search.</div>
  }

  <!-- Overlay player with Angular YouTube Player -->
  @if (selectedVideo() && !isMinimized()) {
  <app-video-player
    [video]="selectedVideo()!"
    (closePlayer)="closeVideo()"
    (minimizePlayer)="minimizeVideo()"
    (playerReady)="onPlayerReady($event)"
    (stateChange)="onPlayerStateChange($event)"
  >
  </app-video-player>
  }

  <!-- Minimized Videos Stack -->
  <app-minimized-videos
    [videos]="minimizedVideos()"
    [playerState]="playerState()"
    (restore)="restoreVideo($event)"
    (close)="closeVideo($event)"
    (togglePlayPause)="togglePlayPause($event)"
    (playerReady)="onPlayerReady($event)"
    (stateChange)="onPlayerStateChange($event)"
  >
  </app-minimized-videos>
  }
</div>

<!-- Toast notifications -->
<div class="toast-container" aria-live="polite" aria-atomic="true">
  @for (t of toastMessages(); track t.id) {
  <div
    class="toast-item"
    [class.toast-info]="t.severity === 'info'"
    [class.toast-warning]="t.severity === 'warning'"
    [class.toast-error]="t.severity === 'error'"
    [class.toast-critical]="t.severity === 'critical'"
    role="alert"
  >
    <div class="toast-message">{{ t.message }}</div>
    <button class="toast-close" (click)="dismissToast(t.id)" aria-label="Dismiss">√ó</button>
  </div>
  }
</div>
